This code was directly copied from `cargo` with very minor modifications.
